//@file    USART.h
#include "stm32f10x_usart.h"
#include "stmflash.h"

//[地址][波特率][波特率][波特率][模式][时间][时间][零点][零点][精度]
u8 TEXT_Buffer[]={0x02,0x20,0xA1,0x07,0x00,0xE8,0x03,0x00,0x00,0x03};
#define SIZE sizeof(TEXT_Buffer)	 			  	//数组长度
#define FLASH_SAVE_ADDR  0X0800F800 				//设置FLASH 保存地址(必须为偶数)
u8 Canshu_Buffer[SIZE];


#define   SET_RE    GPIOA->ODR|=(1<<8);
#define   RESET_RE  GPIOA->ODR&=~(1<<8);

unsigned char ReceiveData=0X0;
u8 ReceiveData_All[]={0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
u8 SendData_All[]={0x00,0x00,0x00,0x00,0x00,0x00,0x00};

short int SpeedA=0;
short int SpeedB=0;
u8 U485_FLAG=0;
u8 USART1_i=0;
u8 Receive_Flag=1;
int Test_Num = 0;
int ABSNum = 0;//编码器的值
int ABSNum2 = 0;//2号编码器的值

float Cdo1 = 0;
int DO1 = 0;
float Cdo2 = 0;
int DO2 = 0;
int ICdo1 = 0;

int ABSNumLast=0;//编码器的值
int ABSNumLast2=0;//编码器的值
float ABSNumOK=0;
float ABSNumxiao = 0;
float ABSNumxiao2 = 0;
u16 angle_tempA =0;
u16 angle_tempB =0;
u16 angle_tempC =0;
u16 angle_tempD =0;
u16 angle_tempE =0;

u16 angle2_tempA =0;
u16 angle2_tempB =0;
u16 angle2_tempC =0;
u16 angle2_tempD =0;
u16 angle2_tempE =0;
u8 NumT = 0;

int AddNum = 0;
int ABSNumNow = 0;
int AddTime = 0;
//#ifndef __USART_H
//#define __USART_H

////@file    USART.h
//#include "stm32f10x_usart.h"
//#include "stmflash.h"
//#include "ADC.h"

#include "stdio.h"
#define UART_RX_LEN 100
u8 Uart_Send_Buffer[UART_RX_LEN];
u8 ii=0;
u8 Flag_Uart_Send=0;

int fputc(int ch, FILE *f)
{
//	USART_SendData(UART4, (unsigned char) ch);
//	while (!(UART4->SR & USART_FLAG_TXE));
	
	Uart_Send_Buffer[ii]=((unsigned char) ch);
	ii++;
	return (ch);
}

int GetKey (void) 
{ 
	while (!(USART1->SR & USART_FLAG_RXNE));
	return ((int)(USART1->DR & 0x1FF));
}

 int8_t wucha[]={0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,0,0,0,0,-1,0,0,0,0,0,0,0,0,0,-1,0,0,0,0,-1,0,0,0,0,0,0,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-1,-2,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-3,-3,-2,-3,-2,-3,-3,-2,-2,-2,-2,-3,-3,-3,-3,-3,-3,-3,-3,-3,-2,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-4,-4,-4,-3,-3,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-5,-4,-4,-4,-4,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-6,-5,-5,-6,-5,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-7,-6,-6,-7,-6,-7,-7,-7,-6,-6,-7,-7,-6,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-8,-7,-7,-7,-8,-8,-8,-8,-8,-8,-7,-7,-8,-8,-8,-8,-7,-8,-8,-8,-8,-8,-8,-8,-8,-7,-8,-8,-8,-8,-8,-8,-8,-8,-9,-9,-8,-8,-8,-8,-9,-9,-8,-9,-8,-9,-9,-8,-8,-9,-8,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-10,-9,-10,-10,-10,-9,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-11,-11,-10,-10,-10,-10,-10,-11,-11,-10,-10,-11,-11,-10,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-12,-11,-11,-12,-12,-12,-12,-11,-11,-11,-11,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-11,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-13,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-13,-13,-13,-12,-12,-13,-12,-13,-13,-13,-13,-13,-13,-12,-12,-12,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-14,-13,-14,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-14,-13,-13,-13,-13,-13,-14,-13,-14,-13,-13,-13,-13,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-15,-14,-14,-14,-14,-14,-15,-14,-14,-14,-15,-15,-15,-15,-15,-15,-14,-14,-15,-15,-15,-14,-15,-15,-14,-14,-14,-15,-15,-15,-15,-14,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-16,-16,-15,-16,-15,-15,-15,-15,-16,-16,-15,-15,-16,-16,-16,-16,-16,-16,-16,-16,-15,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-17,-17,-16,-16,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-19,-18,-18,-19,-18,-18,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-20,-20,-20,-19,-20,-20,-19,-20,-20,-19,-20,-20,-20,-20,-20,-20,-20,-20,-20,-20,-20,-20,-20,-20,-21,-21,-21,-20,-20,-20,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-22,-21,-22,-22,-22,-22,-22,-22,-22,-22,-22,-22,-22,-22,-22,-22,-22,-23,-22,-22,-22,-22,-22,-22,-22,-23,-22,-23,-23,-23,-23,-23,-23,-23,-23,-23,-22,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-24,-23,-23,-23,-23,-24,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-24,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-23,-22,-22,-23,-23,-23,-23,-23,-23,-23,-23,-23,-22,-22,-23,-22,-22,-23,-22,-22,-23,-23,-23,-23,-22,-22,-23,-23,-23,-23,-23,-23,-23,-22,-22,-22,-22,-22,-22,-22,-22,-22,-22,-22,-22,-22,-21,-22,-22,-22,-22,-22,-22,-22,-22,-22,-22,-22,-21,-21,-21,-21,-21,-22,-22,-21,-22,-21,-21,-22,-21,-21,-22,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-21,-20,-21,-21,-21,-20,-20,-20,-20,-20,-20,-20,-20,-20,-20,-20,-20,-20,-20,-20,-20,-20,-20,-20,-20,-19,-20,-20,-20,-19,-20,-20,-20,-19,-19,-19,-19,-19,-19,-20,-20,-19,-20,-19,-19,-20,-20,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-18,-18,-19,-18,-19,-19,-18,-18,-18,-19,-18,-18,-19,-19,-18,-18,-18,-18,-19,-18,-18,-18,-18,-18,-18,-18,-18,-19,-19,-19,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-18,-17,-17,-17,-17,-18,-18,-17,-17,-18,-18,-17,-17,-17,-17,-18,-18,-18,-17,-17,-17,-18,-17,-17,-18,-17,-17,-17,-17,-17,-17,-18,-17,-18,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-18,-17,-17,-17,-16,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-18,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-16,-16,-17,-17,-17,-16,-17,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-17,-16,-16,-17,-17,-16,-16,-17,-17,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-15,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-15,-16,-15,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-15,-16,-16,-16,-15,-15,-16,-15,-16,-16,-15,-16,-16,-16,-16,-15,-15,-15,-16,-15,-16,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-14,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-14,-14,-15,-15,-15,-15,-14,-14,-14,-15,-14,-14,-14,-14,-15,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-13,-13,-13,-13,-14,-13,-13,-14,-13,-13,-13,-14,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-12,-12,-13,-13,-12,-13,-13,-13,-13,-13,-13,-12,-13,-13,-12,-12,-12,-12,-12,-12,-12,-13,-12,-12,-12,-12,-12,-11,-12,-12,-11,-11,-12,-12,-12,-11,-12,-12,-12,-11,-11,-12,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-10,-11,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-8,-8,-8,-8,-9,-8,-8,-8,-8,-9,-9,-8,-8,-8,-8,-8,-8,-8,-8,-8,-8,-8,-8,-8,-8,-8,-8,-8,-8,-8,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-6,-7,-7,-7,-6,-7,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-5,-5,-6,-6,-6,-6,-6,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-4,-4,-5,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-1,-2,-2,-1,-1,-2,-1,-1,-1,-1,-1,-1,-1,-2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,-1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,3,2,2,2,2,2,2,2,2,3,2,2,3,2,3,3,3,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,3,3,4,3,3,4,3,3,4,4,4,4,4,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,4,5,5,4,4,5,5,5,5,5,5,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,5,6,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,6,6,6,6,6,7,7,7,7,7,7,7,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,6,7,7,7,7,7,6,7,7,7,7,7,7,7,7,7,7,7,6,7,6,6,7,7,7,7,7,7,6,7,7,7,7,7,7,6,6,7,7,7,7,7,7,7,7,7,7,7,6,6,6,6,6,6,7,7,7,7,7,7,7,6,6,6,6,6,7,7,7,7,6,6,7,7,6,6,6,6,6,6,7,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,5,5,6,6,6,5,6,6,6,5,6,5,6,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,4,5,4,4,5,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,3,3,3,4,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-3,-2,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-4,-3,-3,-3,-3,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-5,-4,-5,-5,-5,-4,-4,-4,-4,-4,-4,-5,-5,-5,-5,-5,-5,-5,-5,-5,-6,-6,-5,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-7,-7,-7,-7,-7,-7,-7,-7,-7,-6,-7,-7,-7,-7,-7,-8,-8,-7,-8,-8,-8,-7,-7,-7,-8,-8,-8,-8,-8,-7,-8,-8,-8,-8,-8,-8,-8,-8,-8,-8,-8,-8,-8,-8,-8,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-10,-10,-9,-9,-10,-9,-9,-9,-9,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-11,-10,-10,-10,-10,-11,-10,-11,-10,-11,-11,-11,-11,-11,-11,-10,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-12,-12,-12,-12,-11,-12,-11,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-13,-13,-13,-13,-12,-12,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-14,-14,-14,-13,-13,-14,-14,-14,-14,-13,-13,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-17,-17,-17,-17,-17,-17,-17,-17,-17,-16,-17,-17,-17,-16,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-18,-17,-17,-17,-17,-17,-17,-17,-17,-17,-18,-18,-17,-17,-17,-17,-17,-18,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-16,-16,-16,-16,-16,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-16,-17,-16,-17,-16,-16,-16,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-16,-17,-17,-17,-16,-17,-17,-17,-17,-17,-16,-16,-17,-16,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-16,-16,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-17,-16,-17,-16,-17,-17,-16,-16,-16,-16,-16,-17,-17,-17,-17,-16,-16,-16,-17,-17,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-17,-16,-16,-16,-16,-16,-16,-16,-17,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-15,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-16,-15,-16,-16,-16,-16,-16,-16,-15,-15,-16,-15,-16,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-15,-14,-15,-15,-14,-15,-15,-15,-15,-14,-14,-14,-14,-14,-14,-15,-15,-14,-14,-14,-14,-14,-15,-15,-15,-15,-15,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-14,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-14,-13,-13,-13,-14,-13,-13,-13,-13,-13,-13,-13,-13,-12,-13,-13,-12,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-13,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-12,-11,-11,-11,-11,-11,-12,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-11,-10,-11,-11,-11,-11,-11,-10,-11,-11,-11,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-8,-8,-8,-9,-8,-9,-8,-9,-9,-9,-8,-9,-9,-8,-8,-8,-8,-8,-8,-8,-8,-8,-7,-8,-8,-8,-8,-8,-8,-9,-8,-8,-8,-8,-8,-8,-8,-7,-8,-7,-8,-8,-7,-8,-8,-8,-8,-7,-8,-7,-8,-8,-8,-8,-8,-7,-7,-7,-7,-7,-7,-7,-8,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-7,-6,-7,-7,-6,-7,-7,-7,-7,-6,-7,-6,-7,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-6,-5,-6,-6,-6,-6,-6,-6,-5,-5,-6,-6,-5,-5,-6,-5,-5,-6,-5,-5,-5,-5,-5,-5,-5,-5,-6,-6,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-4,-4,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-4,-5,-4,-5,-5,-5,-5,-5,-5,-5,-4,-4,-5,-5,-4,-4,-4,-5,-5,-5,-5,-5,-5,-5,-5,-4,-5,-4,-4,-5,-5,-5,-5,-5,-5,-4,-4,-4,-5,-5,-5,-4,-4,-4,-4,-4,-5,-4,-5,-4,-4,-4,-5,-5,-5,-4,-4,-4,-4,-4,-4,-4,-4,-5,-5,-5,-5,-4,-4,-4,-4,-4,-4,-5,-5,-5,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-3,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-3,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-3,-3,-4,-4,-3,-3,-3,-4,-4,-4,-3,-3,-3,-3,-4,-3,-4,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-2,-3,-2,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-2,-3,-3,-2,-2,-2,-3,-2,-2,-3,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,-1,-1,-1,-1,-1,0,-1,-1,-1,0,-1,0,0,0,0,0,-1,0,-1,-1,0,0,-1,0,0,0,0,0,0,0,0};
	
////[地址][波特率][波特率][波特率][加速度][过载][超载][零点][零点][精度]
//u8 TEXT_Buffer[]={0x02,0x20,0xA1,0x07,1,150,200,0x00,0x00,0x03};
#define SIZE sizeof(TEXT_Buffer)	 			  	//数组长度
#define FLASH_SAVE_ADDR  0X0800F800 				//设置FLASH 保存地址(必须为偶数)
//u8 Canshu_Buffer[10];

//#define   SET_RE    GPIOA->ODR|=(1<<4);
//#define   RESET_RE  GPIOA->ODR&=~(1<<4);

//unsigned char ReceiveData=0X0;
//u8 ReceiveData_All[]={0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
//u8 SendData_All[]={0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};

////int RecvSpeedA = 0;
//int RecvSpeedA_CAN = 0;
//u8 Fangxiang_Flag = 0;
//short int SpeedA=0;
//u8 Jia_SpeedA = 1;
////short int SpeedB=0;
//u8 U485_FLAG=0;
//u8 USART1_i=0;
//u8 Receive_Flag=1;
//int ABSNum=0x1234;//编码器的值








void USART1_Config(void)
{
	USART_InitTypeDef USART_InitStructure;
	NVIC_InitTypeDef NVIC_InitStructure;

	GPIO_InitTypeDef GPIO_InitStructure;
	RCC_APB2PeriphClockCmd( RCC_APB2Periph_GPIOA | RCC_APB2Periph_AFIO, ENABLE);
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_USART1 , ENABLE);

	USART_InitStructure.USART_BaudRate = 115200;//(datatemp[2] + (datatemp[1] << 8))*100;
	USART_InitStructure.USART_WordLength = USART_WordLength_8b;
	USART_InitStructure.USART_StopBits = USART_StopBits_1;
	USART_InitStructure.USART_Parity = USART_Parity_No;
	USART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None;
	USART_InitStructure.USART_Mode = USART_Mode_Rx | USART_Mode_Tx;

	USART_Init(USART1, &USART_InitStructure);         //按上面参数配置USART1
	USART_ITConfig(USART1, USART_IT_RXNE, ENABLE);    //使能接收中断
	USART_Cmd(USART1, ENABLE);						//使能USART1


	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9;	         //USART1 TX
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;    //复用推挽输出
	GPIO_Init(GPIOA, &GPIO_InitStructure);		       //A端口 

	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10;	         //USART1 RX
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPU;   //复用开漏输入
	GPIO_Init(GPIOA, &GPIO_InitStructure);		            //A端口 

	/* Configure the NVIC Preemption Priority Bits */  
	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_0);	  
	/* Enable the USART1 Interrupt */
	NVIC_InitStructure.NVIC_IRQChannel = USART1_IRQn;
	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 0;
	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
	NVIC_Init(&NVIC_InitStructure); 

}
void Dma_Init(void)
{
	DMA_InitTypeDef DMA_InitStructure;
	NVIC_InitTypeDef NVIC_InitStructure;  

	RCC_AHBPeriphClockCmd(RCC_AHBPeriph_DMA1,ENABLE);
	/*DMAchannel6configuration*/
	DMA_DeInit(DMA1_Channel1);
	DMA_InitStructure.DMA_PeripheralBaseAddr=(u32)(&USART1->DR);//外设地址
	DMA_InitStructure.DMA_MemoryBaseAddr=(u32)Uart_Send_Buffer;
	DMA_InitStructure.DMA_DIR=DMA_DIR_PeripheralDST;//外设作为目的地址//DMA_DIR_PeripheralSRC;//外设作为DMA的源端
	DMA_InitStructure.DMA_BufferSize=5;//BufferSize;//传输大小
	DMA_InitStructure.DMA_PeripheralInc=DMA_PeripheralInc_Disable;//外设递增模式禁止DMA_PeripheralInc_Enable;//外设地址增加
	DMA_InitStructure.DMA_MemoryInc=DMA_MemoryInc_Enable;//内存地址自增
	DMA_InitStructure.DMA_PeripheralDataSize=DMA_PeripheralDataSize_Byte;//传输方式：字节DMA_PeripheralDataSize_Word;//字（32位）
	DMA_InitStructure.DMA_MemoryDataSize=DMA_PeripheralDataSize_Byte;//内存存储方式：字节DMA_MemoryDataSize_Word;
	DMA_InitStructure.DMA_Mode=DMA_Mode_Normal;//DMA_Mode_Normal正常模式，只传送一次;DMA_Mode_Circular:循环模式，不停的传送;
	DMA_InitStructure.DMA_Priority=DMA_Priority_High;
	DMA_InitStructure.DMA_M2M=DMA_M2M_Disable;//DMA_M2M_Enable;
	DMA_Init(DMA1_Channel4,&DMA_InitStructure);

	/*EnableDMAChannel4TransferCompleteinterrupt*/
	DMA_ITConfig(DMA1_Channel4,DMA_IT_TC,ENABLE);
	//
	//USART_DMACmd(USART1,USART_DMAReq_Rx,ENABLE);//串口接收器DMA
	//采用DMA方式发送
	USART_DMACmd(USART1,USART_DMAReq_Tx,ENABLE);
	//启动串口
	USART_Cmd(USART1,ENABLE);
	DMA_Cmd(DMA1_Channel4, ENABLE);

	
	//传输完成则进入DMA1_Channel4中断；

         
        
	 //DMA优先级        
	 NVIC_PriorityGroupConfig(NVIC_PriorityGroup_3);
	 NVIC_InitStructure.NVIC_IRQChannel= DMA1_Channel4_IRQn; 
	 NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority= 2; 
	 NVIC_InitStructure.NVIC_IRQChannelSubPriority= 1; 
	 NVIC_InitStructure.NVIC_IRQChannelCmd= ENABLE; 
	 NVIC_Init(&NVIC_InitStructure);
}

//串口1  DMA方式发送中断
void DMA1_Channel4_IRQHandler(void)
{      
	//清除标志位
	DMA_ClearFlag(DMA1_FLAG_TC4); 
	//关闭DMA 
	DMA_Cmd(DMA1_Channel4,DISABLE); 
	Flag_Uart_Send = 0;
                  
}
/*************************校验码计算函数*************************/
unsigned int Crc_Count(unsigned char pbuf[],unsigned char num)
{
   int i,j;
   unsigned int wcrc=0xffff;
   for(i=0;i<num;i++)
   {
     wcrc^=(unsigned int)(pbuf[i]);
	 for (j=0;j<8;j++)
	 {
	    if(wcrc&0x0001)
		{
		   wcrc>>=1;
		   wcrc^=0xa001;
		}
		else
			wcrc>>=1;
	 }
   }   
   return wcrc;
}

/**********************************发送函数************************************************************/
void USART_Transmit(USART_TypeDef* USARTx,u8 *data,int num)	 //发送数组
{
	while(num--)
	{
		while(USART_GetFlagStatus(USARTx,USART_FLAG_TXE)==RESET);//发送寄存器空
		USART_SendData(USARTx,*data++);//发送单个数据//USART1->DR=*data++;
		while(USART_GetFlagStatus(USARTx,USART_FLAG_TC)==RESET);//等待数据帧发送完毕
	}
}
void USART_Transmit1(USART_TypeDef* USARTx,u8 data)//发送一个字节
{ 
   while(USART_GetFlagStatus(USARTx,USART_FLAG_TXE)==RESET);//发送寄存器空
	 USART_SendData(USARTx,data);//发送单个数据//USART1->DR=*data++;
	 while(USART_GetFlagStatus(USARTx,USART_FLAG_TC)==RESET);//等待数据帧发送完毕
}
//TEXT_Buffer[0]=ReceiveData_All[2];
//STMFLASH_Write(FLASH_SAVE_ADDR,(u16*)TEXT_Buffer,SIZE);
//STMFLASH_Read(FLASH_SAVE_ADDR,(u16*)datatemp,SIZE);
//u8 SendData_All[]={0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
void USART1_IRQHandler(void)
{  
	unsigned short int cr1;
  if(USART_GetITStatus(USART1, USART_IT_RXNE) != RESET)
	{	
		ReceiveData = USART_ReceiveData(USART1);
		for(USART1_i=0;USART1_i<7;USART1_i++)
	  {
			ReceiveData_All[USART1_i]=ReceiveData_All[USART1_i+1];
		}
		ReceiveData_All[7]=ReceiveData;

			
			cr1=Crc_Count(ReceiveData_All,6); //计算出校验码
			
			if(cr1==(ReceiveData_All[6]+(ReceiveData_All[7]<<8)))
			{		
//				xxxxx++;		
				if(ReceiveData_All[0]==1)//判断地址码是否正确
				{
					switch(ReceiveData_All[1])//判断功能码
					{
						case 0x03://读编码器值
							{	

									SendData_All[0]=1;
									SendData_All[1]=0x03;
									SendData_All[2]=0x02;
									SendData_All[3]=Test_Num>>8;
									SendData_All[4]=Test_Num;
									SET_RE;
									cr1=Crc_Count(SendData_All,5); 
									SendData_All[5]=cr1;
									SendData_All[6]=cr1>>8;
									USART_Transmit(USART1,SendData_All,7);
									RESET_RE;
              };break;
						default:break;
					}
				}
			}
		USART_ClearFlag(USART1,USART_FLAG_RXNE);
  }
	
	if(USART_GetFlagStatus(USART1, USART_FLAG_ORE) != RESET)
	{ 
		ReceiveData = USART_ReceiveData(USART1); 
		USART_ClearFlag(USART1, USART_FLAG_ORE);
	}

	if(USART_GetFlagStatus(USART1, USART_FLAG_NE) != RESET)USART_ClearFlag(USART1, USART_FLAG_NE);
	if(USART_GetFlagStatus(USART1, USART_FLAG_FE) != RESET)USART_ClearFlag(USART1, USART_FLAG_FE);
	if(USART_GetFlagStatus(USART1, USART_FLAG_PE) != RESET)USART_ClearFlag(USART1, USART_FLAG_PE);

}

//#endif 





